# Cloud Resume Backend SAM stack 

The Infrastructure-as-Code (IaC) description of the AWS resources composing the backend of my [cloud resume application](https://resume.laripping.com).
All neatly described using [AWS Serverless Application Model (SAM)](https://aws.amazon.com/serverless/sam/), ready to deploy with just a few `sam` commands using the [SAM CLI](https://github.com/aws/aws-sam-cli) 

The SAM stack consists of:
- An API Gateway Rest API : that the frontend JS will interact with 
- A DynamoDB Table : holding visitors' User Agents and IP addresses
- A Python Lambda Function : serving as the controller that bridges the two

Extra goodies
- [ ] Tests (Integration & Unit)
- [ ] CI/CD pipelines (using Github Actions)


## Develop Locally
> üí° Notes for me

- Download PyCharm and install the AWS IntelliJ Toolkit
- Git clone and Open the project into PyCharm
- Configure the AWS Toolkit with an IAM user (eg. `aws-toolkit`) and confirm you can access CloudWatch logs 
  1. From the sidebar, expand the AWS Toolkit window
  2. In the first dropdown, choose the `aws-toolkit` IAM profile you've just configured
  3. In the second dropdown pick `eu-west-2` region
  4. Refresh
  5. Under CloudWatch Logs, there should be an entry like `/aws/lambda/sam-app-... `



### SAM CLI prep

On first run, configure SAM cli as follows 
1. Create an IAM user for the SAM CLI (eg. `samcli`)
> üîí Follow Least Privilege Principle: the minimum set of permissions it needs to work most of the times is described [here](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-permissions.html#sam-permissions-managed-policies) 
2. Configure your AWS CLI with its creds (*as the default profile*) using `aws configure` 
> ‚ùå Unfortunately SAM CLI doesn't consistently follow `AWS_PROFILE` env, so we need have samcli be the default globally  
3. Extract the (fixed and rigid) stack name from conf, to use in commands
```bash
$ STACK_NAME=$(grep stack_name samconfig.toml | cut -d \" -f 2)
```



### AWS Resources

When messing with the `template.yaml` adding/removing AWS resources, follow the SAM cli workflow below:


```bash
$ sam build # --use-container takes way too long
$ # sam package <- use this to feed packaged.yaml to the next steps, if anything complains about the lack of S3 urls
$ sam deploy --stack-name $STACK_NAME  
$ sam local invoke      # tests the function
$ sam local start-api   # tests the API + the function 
```

From now on, you can edit/test the Python code as described below, and see it live by hitting http://127.0.0.1:3000/fetch-update-visitor-count. 
- No need to rebuild/redeploy as changes will appear instantly (mounted docker env)
- Do rebuild if you change `template.yaml`



### Python Lambda Function 

To develop/test the Lambda function locally, using PyCharm in a WSL environment, you need a pyenv / pip / virtualenv combo:
```bash
$ cd hellow_world
$ pyenv virtualenv 3.8.0 .venv
$ pyenv activate .venv
$ python3 -m pip install -r requirements.txt
$ # do work, add imports... then update
$ python3 -m pip freeze > requirements.txt
```

Note that PyCharm won't work well with an interpreter inside WSL, so instead create another virtualenv interpreter for the project in Windows land, based off of Python(.exe) 3.8  with the `fetch_visitors/requirements.txt`. Name the virtualenv `venv` as to be ignored by git.




### Troubleshooting 
- If you get weird Python SAM cli errors after `sam local invoke` maybe wait for a min / kill docker, it could be the mounted FS... or just `cd ../ && cd -`
- `sam deploy` complaining with "S3 Bucket not specified..." might be a silent permissions problem, as implicit assumption of an unintended profile forces the S3 call to fail misinterpretting it as an empty response. Make sure the right profile is picked up with `--debug`  

<hr>

# Boilerplate README below

## ~~Fetch, tail, and filter Lambda function logs~~
> ‚ùå This just doesn't work

To simplify troubleshooting, SAM CLI has a command called `sam logs`. `sam logs` lets you fetch logs generated by your deployed Lambda function from the command line. In addition to printing the logs on the terminal, this command has several nifty features to help you quickly find the bug.

`NOTE`: This command works for all AWS Lambda functions; not just the ones you deploy using SAM.

```bash
my-sam-tutorial-app$ sam logs -n HelloWorldFunction --stack-name my-sam-tutorial-app --tail
```

You can find more information and examples about filtering Lambda function logs in the [SAM CLI Documentation](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-logging.html).

## Tests

Tests are defined in the `tests` folder in this project. Use PIP to install the test dependencies and run tests.

```bash
my-sam-tutorial-app$ pip install -r tests/requirements.txt --user
# unit test
my-sam-tutorial-app$ python -m pytest tests/unit -v
# integration test, requiring deploying the stack first.
# Create the env variable AWS_SAM_STACK_NAME with the name of the stack we are testing
my-sam-tutorial-app$ AWS_SAM_STACK_NAME=<stack-name> python -m pytest tests/integration -v
```

## Cleanup

To delete the sample application that you created, use the AWS CLI. Assuming you used your project name for the stack name, you can run the following:

```bash
aws cloudformation delete-stack --stack-name my-sam-tutorial-app
```
